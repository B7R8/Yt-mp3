# ===================================================================
# Upstream (Load Balancer)
# ===================================================================
upstream frontend_servers {
    server frontend:80; 
}

upstream backend_servers {
    server backend:3001;
}

# ===================================================================
# Rate Limiting & Connection Limiting
# ===================================================================
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=general:10m rate=30r/s;
limit_req_zone $binary_remote_addr zone=download:10m rate=5r/s;
limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;

# ===================================================================
# Les serveurs dyalek
# ===================================================================

# Server HTTP li kay'rediregi kolchi l HTTPS dyal domaine
server {
    listen 80;
    # ===> TBDILA 1: ZDNA L'IP HNA <===
    server_name saveytb.com www.saveytb.com 31.97.149.135;

    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    location / {
        # ===> TBDILA 2: Drna redirection dima l'domaine <===
        return 301 https://saveytb.com$request_uri;
    }
}

# Server HTTPS (L'khdma l'7aqiqiya dyal domaine)
server {
    listen 443 ssl;
    http2 on;
    server_name saveytb.com www.saveytb.com;

    # SSL Config
    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;

    # Security Headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header X-Permitted-Cross-Domain-Policies "none" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    

    # Prevent source code inspection
    add_header X-Source-Map "none" always;
    add_header X-DevTools-Override "none" always;

    # Optimizations
    client_max_body_size 100M;
    server_tokens off;

    # Gzip, Connection Limit, etc...
    gzip on;
    gzip_vary on;
    limit_conn conn_limit_per_ip 20;

    # Proxy l'Frontend
    location / {
        limit_req zone=general burst=20 nodelay;
        proxy_pass http://frontend_servers;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Proxy l'Backend API
    location /api/ {
        limit_req zone=api burst=10 nodelay;
        proxy_pass http://backend_servers;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
    }

    # Proxy l'Download
    location ~ ^/api/download/ {
        limit_req zone=download burst=5 nodelay;
        proxy_pass http://backend_servers;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_read_timeout 300s;
    }

    # ===================================================================
    # ===> SOURCE CODE PROTECTION <===
    # ===================================================================
    
    # Block common dev tools paths
    location ~* /(devtools|inspect|debugger|console|source) {
        return 404;
    }

    # Block source map requests
    location ~* \.map$ {
        return 404;
    }
    
    # Block access to source files
    location ~* \.(ts|tsx|jsx|js\.map|css\.map)$ {
        return 404;
    }
    
    # Block access to development files
    location ~* \.(config|env|json)$ {
        return 404;
    }
    
    # Block access to node_modules
    location ~* /node_modules/ {
        return 404;
    }
    
    # Block access to src directory
    location ~* /src/ {
        return 404;
    }
    
    # Block access to package files
    location ~* /(package\.json|package-lock\.json|yarn\.lock|tsconfig\.json|vite\.config\.ts)$ {
        return 404;
    }
    
    # Block access to git files
    location ~* /\.git/ {
        return 404;
    }
    
    # Block access to editor files
    location ~* /\.(vscode|idea|sublime)/ {
        return 404;
    }
}

# ===================================================================
# ===> BLOC JDID: Bach y'redirecti men l'IP b HTTPS l'domaine <===
# ===================================================================
server {
    listen 443 ssl;
    http2 on;
    server_name 31.97.149.135; # L'IP dyal VPS

    # Khassna n3awdo n7etto les certificats hna
    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/privkey.pem;

    # L'instruction dyal redirection
    return 301 https://saveytb.com$request_uri;
}